# Note: change to batch/v1beta1 once we bump to k8s 1.8
apiVersion: batch/v2alpha1
kind: CronJob
metadata:
  name: useryamls3
spec:
  schedule: "@hourly"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: useryaml-job
          volumes:
            - name: config-volume
              secret:
                secretName: "fence-secret"
            - name: json-secret-volume
              secret:
                secretName: "fence-json-secret"
            - name: fence-jwt-keys
              secret:
                secretName: "fence-jwt-keys"
            - name: fence-yaml
              configMap:
                name: fence
            - name: cert-volume
              secret:
                secretName: "cert-fence-service"
            - name: ca-volume
              secret:
                secretName: "service-ca"
          containers:
          - name: useryaml
            image: quay.io/cdis/fence:chore_automation
            volumeMounts:
              - name: "config-volume"
                readOnly: true
                mountPath: "/var/www/fence/local_settings.py"
                subPath: local_settings.py
              - name: "json-secret-volume"
                readOnly: true
                mountPath: "/var/www/fence/fence_credentials.json"
                subPath: fence_credentials.json
              - name: "fence-yaml"
                mountPath: "/var/www/fence/user.yaml"
                subPath: user.yaml
              - name: "cert-volume"
                readOnly: true
                mountPath: "/mnt/ssl/service.crt"
                subPath: "service.crt"
              - name: "cert-volume"
                readOnly: true
                mountPath: "/mnt/ssl/service.key"
                subPath: "service.key"
              - name: "ca-volume"
                readOnly: true
                mountPath: "/mnt/ssl/cdis-ca.crt"
                subPath: "ca.pem"
              - name: "fence-jwt-keys"
                readOnly: true
                mountPath: "/fence/keys"
            command: ["/bin/bash" ]
            args: 
              - "-c" 
              - |
                echo "syncing useryaml";
                aws s3 cp $userYamlS3Path /tmp/user.yaml;
                fence-create create /tmp/user.yaml;
                kubectl delete configmap fence
                kubectl create configmap fence --from-file=/tmp/user.yaml 
            env:
            - name: userYamlS3Path
              valueFrom:
                  configMapKeyRef:
                    name: global
                    key: useryaml_s3path
          restartPolicy: Never
            
  